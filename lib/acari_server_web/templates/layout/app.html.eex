<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Богатка</title>
    <link rel="stylesheet" href="<%= Routes.static_path(@conn, "/css/app.css") %>"/>
  </head>


  <body>
    <% mes_list = get_mes()
       num_of_mes = mes_list |> length() %>
    <nav class="navbar navbar-expand navbar-dark flex-sm-nowrap p-0 justify-content-between"
          style="background-color: #305478;">
      <a class="navbar-brand col col-md-2 mr-0" href="#">NSG</a>
      <div class="navbar-nav px-3 d-flex flex-wrap">
        <span class="navbar-text pr-3">
          <%= AcariServer.Mnesia.get_server_name_by_system_name(node()) %>
          <i class="fas fa-server"></i>
        </span>
        <span class="navbar-text pr-0"><%= username(@conn) %> <i class="fas fa-user-alt"></i></span>
        <a class="nav-link ml-2" data-toggle="collapse" href="#collapseMessages" role="button"   aria-expanded="false" aria-controls="collapseMessages">
          <span class="d-none d-md-block">Сообщения <i class="fas fa-bell"></i>
          <span class="badge badge-warning mr-2  ml-1 pt-1" id="num-of-mes"><%= num_of_mes %></span></span>
          <span class="d-md-none"> <i class="fas fa-bell"></i>
          <span class="badge badge-warning mr-2  ml-1 pt-1" id="num-of-mes"><%= num_of_mes %></span></spsn>
        </a>
        <%= link to: Routes.session_path(@conn, :logout),class: "nav-link", method: :logout, data: [confirm: "Вы уверены?"] do %>
             <span class="d-none d-md-block">Выйти <i class="fas fa-sign-out-alt"></i></span>
             <span class="d-md-none"> <i class="fas fa-sign-out-alt"></i></span>
        <% end %>

      </div>
    </nav>

    <nav class = "navbar d-block d-md-none navbar-light">
      <span class="navbar-text font-weight-bold">Меnu</span>
      <button class="navbar-toggler float-right" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="collapsibleNavbar">
        <%= render "menu.html", assigns %>
      </div>
    </nav>

    <div class="container-fluid">

      <div class="row">
        <nav class="col-md-2 d-none d-md-block sidebar pr-0">
          <div class="sidebar-sticky">
            <%= render "menu.html", assigns %>
          </div>
        </nav>

        <div class="col-md-10 ml-sm-auto px-4 bg-light pt-3 pb-3 flex-grow-1">
          <div class="row d-flex flex-wrap-reverse flex-lg-nowrap">
            <main role="main" class="col-12 col-lg px-0 px-lg-4 mr-1" id="mainPage" style="overflow-x: auto">
              <% dsl = AcariServer.Mnesia.get_down_servers()
                 usl = AcariServer.Mnesia.get_unregistered_servers()
                 db_conn = AcariServer.RepoManager.get_db_conn()
              %>
              <%= if dsl != [] or usl != [] or db_conn[:rw] == nil or db_conn[:ro] == nil do %>
                <p class="alert alert-danger" role="alert">
                  <%= if db_conn[:rw] == nil do %>
                    Нет соединения с главной БД</br>
                  <% end %>
                  <%= if db_conn[:ro] == nil do %>
                    Нет соединения с БД для чтения</br>
                  <% end %>
                  <%= if dsl != [] do %>
                    <%= for ser <- dsl do %>
                    Сервер <%= ser %> не работает</br>
                    <% end %>
                    <%= if usl != [] do %>
                      </br>
                    <% end %>
                  <% end %>
                  <%= if usl != [] do %>
                    Обнаружены незарегистртрованные сервера: <%= usl |> Enum.join(", ") %>
                  <% end %>
                </p>
              <% end %>
              <p class="alert alert-info" role="alert"><%= get_flash(@conn, :info) %></p>
              <p class="alert alert-danger" role="alert"><%= get_flash(@conn, :error) %></p>
              <%= render @view_module, @view_template, assigns %>
            </main>

            <div class="col-lg-3 col-12 collapse p-0" id="collapseMessages">
              <h5>Сообщения:</h5>
                    <ul class="list-group p-0" id="event-log">
                      <%= render "messages.html", assigns |> Map.put(:mes_list, mes_list) %>
                    </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="About" tabindex="-1" role="dialog" aria-labelledby="AboutTitle" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="AboutTitle">Богатка</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p>ООО "ЭН-ЭС-ДЖИ" (NSG Ltd.)</p>
            <p>Версия <%= {:ok, vsn} = :application.get_key(:acari_server, :vsn); vsn %></p>
          </div>
        </div>
      </div>
    </div>

    <script type="text/javascript" src="<%= Routes.static_path(@conn, "/js/app.js") %>"></script>
  </body>
</html>
